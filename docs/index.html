<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>User-defined functions that DBI + RPostgres users should have</title>
  <meta name="description" content="User-defined functions that DBI + RPostgres users should have" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="User-defined functions that DBI + RPostgres users should have" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="https://github.com/Shena4746/r-functions-on-dbi" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="User-defined functions that DBI + RPostgres users should have" />
  
  
  

<meta name="author" content="Shena" />


<meta name="date" content="2022-07-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #232629;
    color: #7a7c7d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
div.sourceCode
  { color: #cfcfc2; background-color: #232629; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #cfcfc2; } /* Normal */
code span.al { color: #95da4c; } /* Alert */
code span.an { color: #3f8058; } /* Annotation */
code span.at { color: #2980b9; } /* Attribute */
code span.bn { color: #f67400; } /* BaseN */
code span.bu { color: #7f8c8d; } /* BuiltIn */
code span.cf { color: #fdbc4b; } /* ControlFlow */
code span.ch { color: #3daee9; } /* Char */
code span.cn { color: #27aeae; } /* Constant */
code span.co { color: #7a7c7d; } /* Comment */
code span.cv { color: #7f8c8d; } /* CommentVar */
code span.do { color: #a43340; } /* Documentation */
code span.dt { color: #2980b9; } /* DataType */
code span.dv { color: #f67400; } /* DecVal */
code span.er { color: #da4453; } /* Error */
code span.ex { color: #0099ff; } /* Extension */
code span.fl { color: #f67400; } /* Float */
code span.fu { color: #8e44ad; } /* Function */
code span.im { color: #27ae60; } /* Import */
code span.in { color: #c45b00; } /* Information */
code span.kw { color: #cfcfc2; } /* Keyword */
code span.op { color: #cfcfc2; } /* Operator */
code span.ot { color: #27ae60; } /* Other */
code span.pp { color: #27ae60; } /* Preprocessor */
code span.re { color: #2980b9; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #da4453; } /* SpecialString */
code span.st { color: #f44f4f; } /* String */
code span.va { color: #27aeae; } /* Variable */
code span.vs { color: #da4453; } /* VerbatimString */
code span.wa { color: #da4453; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path=""><a href="#about"><i class="fa fa-check"></i><b>1</b> About</a><ul>
<li class="chapter" data-level="1.1" data-path=""><a href="#libraries"><i class="fa fa-check"></i><b>1.1</b> Libraries</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path=""><a href="#connections"><i class="fa fa-check"></i><b>2</b> Connections</a><ul>
<li class="chapter" data-level="2.1" data-path=""><a href="#issue-con"><i class="fa fa-check"></i><b>2.1</b> Issue a connection variable</a><ul>
<li class="chapter" data-level="2.1.1" data-path=""><a href="#definition"><i class="fa fa-check"></i><b>2.1.1</b> Definition</a></li>
<li class="chapter" data-level="2.1.2" data-path=""><a href="#example"><i class="fa fa-check"></i><b>2.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path=""><a href="#release-cons"><i class="fa fa-check"></i><b>2.2</b> Disconnect connections</a><ul>
<li class="chapter" data-level="2.2.1" data-path=""><a href="#definition-1"><i class="fa fa-check"></i><b>2.2.1</b> Definition</a></li>
<li class="chapter" data-level="2.2.2" data-path=""><a href="#example-1"><i class="fa fa-check"></i><b>2.2.2</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path=""><a href="#views"><i class="fa fa-check"></i><b>3</b> Views</a><ul>
<li class="chapter" data-level="3.1" data-path=""><a href="#create-view"><i class="fa fa-check"></i><b>3.1</b> Create a view</a><ul>
<li class="chapter" data-level="3.1.1" data-path=""><a href="#definition-2"><i class="fa fa-check"></i><b>3.1.1</b> Definition</a></li>
<li class="chapter" data-level="3.1.2" data-path=""><a href="#example-2"><i class="fa fa-check"></i><b>3.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path=""><a href="#list-views"><i class="fa fa-check"></i><b>3.2</b> List views</a><ul>
<li class="chapter" data-level="3.2.1" data-path=""><a href="#definition-3"><i class="fa fa-check"></i><b>3.2.1</b> Definition</a></li>
<li class="chapter" data-level="3.2.2" data-path=""><a href="#example-3"><i class="fa fa-check"></i><b>3.2.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path=""><a href="#test-views"><i class="fa fa-check"></i><b>3.3</b> Test existence of views</a><ul>
<li class="chapter" data-level="3.3.1" data-path=""><a href="#definition-4"><i class="fa fa-check"></i><b>3.3.1</b> Definition</a></li>
<li class="chapter" data-level="3.3.2" data-path=""><a href="#example-4"><i class="fa fa-check"></i><b>3.3.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path=""><a href="#drop-view"><i class="fa fa-check"></i><b>3.4</b> Drop a view</a><ul>
<li class="chapter" data-level="3.4.1" data-path=""><a href="#definition-5"><i class="fa fa-check"></i><b>3.4.1</b> Definition</a></li>
<li class="chapter" data-level="3.4.2" data-path=""><a href="#example-5"><i class="fa fa-check"></i><b>3.4.2</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path=""><a href="#misc"><i class="fa fa-check"></i><b>4</b> Misc</a><ul>
<li class="chapter" data-level="4.1" data-path=""><a href="#discard"><i class="fa fa-check"></i><b>4.1</b> Free Resources</a><ul>
<li class="chapter" data-level="4.1.1" data-path=""><a href="#definition-6"><i class="fa fa-check"></i><b>4.1.1</b> Definition</a></li>
<li class="chapter" data-level="4.1.2" data-path=""><a href="#example-6"><i class="fa fa-check"></i><b>4.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path=""><a href="#drop-table"><i class="fa fa-check"></i><b>4.2</b> Drop a Table</a><ul>
<li class="chapter" data-level="4.2.1" data-path=""><a href="#definition-7"><i class="fa fa-check"></i><b>4.2.1</b> Definition</a></li>
<li class="chapter" data-level="4.2.2" data-path=""><a href="#example-7"><i class="fa fa-check"></i><b>4.2.2</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path=""><a href="#references"><i class="fa fa-check"></i><b>5</b> References: dbplyr, DBI, RPostgres</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">User-defined functions that DBI + RPostgres users should have</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">User-defined functions that DBI + RPostgres users should have</h1>
<p class="author"><em>Shena</em></p>
<p class="date"><em>2022-07-10</em></p>
</div>
<div id="about" class="section level1 hasAnchor">
<h1><span class="header-section-number">1</span> About<a href="#about" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="https://github.com/Shena4746/r-functions-on-dbi">README on github</a>.</p>
<p>test
<a href="#create-view">3.1</a>
<a href="#test-views">3.3</a>
<a href="#drop-view">3.4</a></p>
<div id="libraries" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.1</span> Libraries<a href="#libraries" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This document is based on the following libraries.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">R.version.string</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">## [1] &quot;R version 4.2.0 (2022-04-22)&quot;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">packageVersion</span>(<span class="st">&quot;RPostgres&quot;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">## [1] &#39;1.4.4.9000&#39;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">packageVersion</span>(<span class="st">&quot;DBI&quot;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">## [1] &#39;1.1.3&#39;</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">packageVersion</span>(<span class="st">&quot;dplyr&quot;</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">## [1] &#39;1.0.9&#39;</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">packageVersion</span>(<span class="st">&quot;dbplyr&quot;</span>)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">## [1] &#39;2.2.1&#39;</span></a></code></pre></div>


</div>
</div>
<div id="connections" class="section level1 hasAnchor">
<h1><span class="header-section-number">2</span> Connections<a href="#connections" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="issue-con" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.1</span> Issue a connection variable<a href="#issue-con" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Retruns a new <code>DBIConnection</code> object used to communicate with a database.</li>
<li>It is recommended that you make sure you have disconnected old connections before using this.</li>
</ul>
<div id="definition" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.1.1</span> Definition<a href="#definition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">issue_con &lt;-<span class="st"> </span><span class="cf">function</span>(service_name) {</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="co"># assume you are using config package and Postgres</span></a>
<a class="sourceLine" id="cb2-3" title="3">    crd &lt;-<span class="st"> </span>config<span class="op">::</span><span class="kw">get</span>(service_name)</a>
<a class="sourceLine" id="cb2-4" title="4">    DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb2-5" title="5">        <span class="dt">drv =</span> RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb2-6" title="6">        <span class="dt">host =</span> crd<span class="op">$</span>host,</a>
<a class="sourceLine" id="cb2-7" title="7">        <span class="dt">port =</span> crd<span class="op">$</span>port,</a>
<a class="sourceLine" id="cb2-8" title="8">        <span class="dt">dbname =</span> crd<span class="op">$</span>dbname,</a>
<a class="sourceLine" id="cb2-9" title="9">        <span class="dt">user =</span> crd<span class="op">$</span>user,</a>
<a class="sourceLine" id="cb2-10" title="10">        <span class="dt">password =</span> crd<span class="op">$</span>password</a>
<a class="sourceLine" id="cb2-11" title="11">    )</a>
<a class="sourceLine" id="cb2-12" title="12">}</a></code></pre></div>
</div>
<div id="example" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.1.2</span> Example<a href="#example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before setting a new connection variable, make sure that you are not trying to issue more connection variables than you need or overwrite exsisting one without disconnect it. So it is a good practice to disconnect before connecting, for instance, using <code>release_cons</code> defined below.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">release_cons</span>() <span class="co"># Don&#39;t forget!</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">## character(0)</span></a>
<a class="sourceLine" id="cb3-3" title="3">con &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb3-4" title="4">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>()</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">## &lt;PqConnection&gt; demo@localhost:5432</span></a></code></pre></div>
</div>
</div>
<div id="release-cons" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.2</span> Disconnect connections<a href="#release-cons" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="definition-1" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.2.1</span> Definition<a href="#definition-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>Disconnects all connection variables whose names are included in the passed vector of strings.</li>
<li>Retruns a vector of characters listing connection variables that are disconnected by the function call.</li>
<li>The arguments <code>search_from =</code> specifies a vector of strings that might contain connection variables to be disconnected. The default is set to a vector of names of all objects in the global namespace.</li>
<li>The arguments <code>except = NULL</code> specifies a vector of strings that should be excluded from <code>search_from</code> argument.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">release_cons &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">search_from =</span> <span class="kw">ls</span>(<span class="st">&quot;.GlobalEnv&quot;</span>), <span class="dt">except =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb4-2" title="2">    purrr<span class="op">::</span><span class="kw">map_chr</span>(</a>
<a class="sourceLine" id="cb4-3" title="3">        <span class="dt">.x =</span> search_from <span class="op">%&gt;%</span><span class="st"> </span>base<span class="op">::</span><span class="kw">setdiff</span>(except),</a>
<a class="sourceLine" id="cb4-4" title="4">        <span class="dt">.f =</span> <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb4-5" title="5">            ret &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb4-6" title="6">            <span class="cf">if</span> (x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="st">                </span>{</a>
<a class="sourceLine" id="cb4-8" title="8">                    <span class="kw">inherits</span>(., <span class="st">&quot;PqConnection&quot;</span>) <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(.) <span class="op">==</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-9" title="9">                }) {</a>
<a class="sourceLine" id="cb4-10" title="10">                ret &lt;-<span class="st"> </span><span class="kw">tryCatch</span>(</a>
<a class="sourceLine" id="cb4-11" title="11">                    {</a>
<a class="sourceLine" id="cb4-12" title="12">                        x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="st">                            </span><span class="kw">get</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="st">                            </span>DBI<span class="op">::</span><span class="kw">dbDisconnect</span>()</a>
<a class="sourceLine" id="cb4-15" title="15">                        <span class="kw">return</span>(x)</a>
<a class="sourceLine" id="cb4-16" title="16">                    },</a>
<a class="sourceLine" id="cb4-17" title="17">                    <span class="dt">error =</span> <span class="cf">function</span>(e) {</a>
<a class="sourceLine" id="cb4-18" title="18">                        msg &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Invalid PqConnection class object is provided:&quot;</span>, x)</a>
<a class="sourceLine" id="cb4-19" title="19">                        <span class="kw">message</span>(msg)</a>
<a class="sourceLine" id="cb4-20" title="20">                    },</a>
<a class="sourceLine" id="cb4-21" title="21">                    <span class="dt">warning =</span> <span class="cf">function</span>(e) {</a>
<a class="sourceLine" id="cb4-22" title="22">                        <span class="kw">return</span>(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb4-23" title="23">                    }</a>
<a class="sourceLine" id="cb4-24" title="24">                )</a>
<a class="sourceLine" id="cb4-25" title="25">            }</a>
<a class="sourceLine" id="cb4-26" title="26">            <span class="kw">return</span>(ret)</a>
<a class="sourceLine" id="cb4-27" title="27">        }</a>
<a class="sourceLine" id="cb4-28" title="28">    ) <span class="op">%&gt;%</span><span class="st"> </span>.[. <span class="op">!=</span><span class="st"> &quot;&quot;</span>]</a>
<a class="sourceLine" id="cb4-29" title="29">}</a></code></pre></div>
</div>
<div id="example-1" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.2.2</span> Example<a href="#example-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">release_cons</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">invisible</span>()</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">con1 &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" title="4">con2 &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">cons &lt;-<span class="st"> </span><span class="kw">release_cons</span>()</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">cons <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>()</a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">## [1] &quot;con1&quot; &quot;con2&quot;</span></a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co"># check that they are actually disconnected</span></a>
<a class="sourceLine" id="cb5-11" title="11">purrr<span class="op">::</span><span class="kw">map_lgl</span>(cons, <span class="op">~</span><span class="st"> </span><span class="kw">dbDisconnect</span>(.x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get</span>()))</a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co">## Warning in connection_release(conn@ptr): Already disconnected</span></a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">## Warning in connection_release(conn@ptr): Already disconnected</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="co">## [1] TRUE TRUE</span></a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="co"># disconnect all connetions but &#39;con&#39;</span></a>
<a class="sourceLine" id="cb5-18" title="18">con &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb5-19" title="19">con1 &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb5-20" title="20">con2 &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb5-21" title="21"><span class="kw">release_cons</span>(<span class="dt">except =</span> <span class="st">&quot;con&quot;</span>)</a>
<a class="sourceLine" id="cb5-22" title="22"><span class="co">## [1] &quot;con1&quot; &quot;con2&quot;</span></a>
<a class="sourceLine" id="cb5-23" title="23">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>() <span class="co"># con is still valid</span></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="co">## &lt;PqConnection&gt; demo@localhost:5432</span></a></code></pre></div>

</div>
</div>
</div>
<div id="views" class="section level1 hasAnchor">
<h1><span class="header-section-number">3</span> Views<a href="#views" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section asssumes that <code>mtcars</code> table has been created in a remote table.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="cf">if</span> (con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsTable</span>(<span class="st">&quot;mtcars&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">isFALSE</span>()) {</a>
<a class="sourceLine" id="cb6-2" title="2">    con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbWriteTable</span>(<span class="st">&quot;mtcars&quot;</span>, mtcars)</a>
<a class="sourceLine" id="cb6-3" title="3">}</a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="st">    </span><span class="kw">dbReadTable</span>(<span class="st">&quot;mtcars&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">##    mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">## 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">## 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">## 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">## 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">## 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">## 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</span></a></code></pre></div>
<div id="create-view" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.1</span> Create a view<a href="#create-view" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Creates a view from the passed SQL query.</li>
<li>Returns <code>TRUE</code> invisibly.</li>
<li><code>temporary = FALSE</code> and <code>or_replace = FALSE</code> arguments specify whether to enable <code>TEMPORARY</code> and <code>OR REPLACE</code> options, respectively.</li>
</ul>
<div id="definition-2" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.1.1</span> Definition<a href="#definition-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">dbCreateView &lt;-<span class="st"> </span><span class="cf">function</span>(con, name, sql, <span class="dt">or_replace =</span> <span class="ot">FALSE</span>, <span class="dt">temporary =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="cf">if</span> (sql <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inherits</span>(<span class="kw">c</span>(<span class="st">&quot;character&quot;</span>, <span class="st">&quot;SQL&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">isFALSE</span>()) <span class="kw">stop</span>(<span class="st">&quot;provided sql string is not of class character or SQL.&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" title="3">    con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">sqlInterpolate</span>(</a>
<a class="sourceLine" id="cb7-5" title="5">            <span class="dt">sql =</span> <span class="st">&quot;CREATE ?or ?tmp VIEW ?name AS ?q&quot;</span>,</a>
<a class="sourceLine" id="cb7-6" title="6">            <span class="dt">or =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(or_replace, <span class="st">&quot;OR REPLACE&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>(),</a>
<a class="sourceLine" id="cb7-7" title="7">            <span class="dt">tmp =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(temporary, <span class="st">&quot;TEMPORARY&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>(),</a>
<a class="sourceLine" id="cb7-8" title="8">            <span class="dt">name =</span> DBI<span class="op">::</span><span class="kw">dbQuoteIdentifier</span>(., name),</a>
<a class="sourceLine" id="cb7-9" title="9">            <span class="dt">q =</span> sql <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>()</a>
<a class="sourceLine" id="cb7-10" title="10">        ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">dbExecute</span>(con, .)</a>
<a class="sourceLine" id="cb7-12" title="12">    <span class="kw">invisible</span>(<span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">return</span>()</a>
<a class="sourceLine" id="cb7-13" title="13">}</a></code></pre></div>
<p>Since <code>DBI::dbExecute</code> does not accept multiple statements, <code>dbCreateView</code> is not subject to SQL injection of that form.</p>
</div>
<div id="example-2" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.1.2</span> Example<a href="#example-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="cf">if</span> (con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsTable</span>(<span class="st">&quot;cars&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">isFALSE</span>()) con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbWriteTable</span>(<span class="st">&quot;cars&quot;</span>, cars)</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="dt">name =</span> <span class="st">&quot;view_cars_20&quot;</span>,</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="dt">sql =</span> <span class="st">&quot;SELECT * FROM cars WHERE dist &lt; 20&quot;</span></a>
<a class="sourceLine" id="cb8-6" title="6">)</a>
<a class="sourceLine" id="cb8-7" title="7">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbReadTable</span>(<span class="st">&quot;view_cars_20&quot;</span>)</a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">##   speed dist</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">## 1     4    2</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">## 2     4   10</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">## 3     7    4</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">## 4     8   16</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">## 5     9   10</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">## 6    10   18</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">## 7    11   17</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">## 8    12   14</span></a>
<a class="sourceLine" id="cb8-17" title="17"></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co"># see the view properly follow the change in the referred table</span></a>
<a class="sourceLine" id="cb8-19" title="19">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbAppendTable</span>(<span class="st">&quot;cars&quot;</span>, <span class="kw">data.frame</span>(<span class="dt">speed =</span> <span class="dv">7</span>, <span class="dt">dist =</span> <span class="dv">19</span>))</a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co">## [1] 1</span></a>
<a class="sourceLine" id="cb8-21" title="21">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbReadTable</span>(<span class="st">&quot;view_cars_20&quot;</span>)</a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co">##   speed dist</span></a>
<a class="sourceLine" id="cb8-23" title="23"><span class="co">## 1     4    2</span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co">## 2     4   10</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="co">## 3     7    4</span></a>
<a class="sourceLine" id="cb8-26" title="26"><span class="co">## 4     8   16</span></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="co">## 5     9   10</span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="co">## 6    10   18</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="co">## 7    11   17</span></a>
<a class="sourceLine" id="cb8-30" title="30"><span class="co">## 8    12   14</span></a>
<a class="sourceLine" id="cb8-31" title="31"><span class="co">## 9     7   19</span></a></code></pre></div>
<p>temporary views vanish when temporary resources are freed, which happenes, for instance, when <code>dbDisconnect()</code> is executed.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars&quot;</span></a>
<a class="sourceLine" id="cb9-2" title="2">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(<span class="st">&quot;view_permanent&quot;</span>, sql)</a>
<a class="sourceLine" id="cb9-3" title="3">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(<span class="st">&quot;view_temporary&quot;</span>, sql, <span class="dt">temporary =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-4" title="4">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">## [1] &quot;mtcars&quot;         &quot;view_permanent&quot; &quot;view_temporary&quot;</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co"># reconnect</span></a>
<a class="sourceLine" id="cb9-7" title="7">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbDisconnect</span>()</a>
<a class="sourceLine" id="cb9-8" title="8">con &lt;-<span class="st"> </span><span class="kw">issue_con</span>(<span class="st">&quot;demo&quot;</span>)</a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co"># temporary table has vanished</span></a>
<a class="sourceLine" id="cb9-10" title="10">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">## [1] &quot;mtcars&quot;         &quot;view_permanent&quot;</span></a></code></pre></div>
<p>Given a set of <code>SELECT</code> queries and names that should be complied as views, you can create those views at once.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">cyls &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb10-2" title="2">names &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(cyls, <span class="op">~</span><span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;view_cyl=&quot;</span>, .x, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb10-3" title="3">sqls &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(cyls, <span class="op">~</span><span class="st"> </span><span class="kw">sqlInterpolate</span>(</a>
<a class="sourceLine" id="cb10-4" title="4">    con,</a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="st">&quot;SELECT * FROM mtcars WHERE cyl = ?cyl&quot;</span>,</a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="dt">cyl =</span> .x</a>
<a class="sourceLine" id="cb10-7" title="7">))</a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co"># vectorised view creation</span></a>
<a class="sourceLine" id="cb10-9" title="9">purrr<span class="op">::</span><span class="kw">map2_lgl</span>(names, sqls, <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, .x, .y))</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">## [1] TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb10-11" title="11">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">## [1] &quot;mtcars&quot;     &quot;view_cyl=4&quot; &quot;view_cyl=6&quot; &quot;view_cyl=8&quot;</span></a></code></pre></div>
<p>The combination of <code>dbCreateView()</code> and the dbplyr package allows you to create views without writing any SQL statements. This is often much quicker than working with SQL.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="cf">if</span> (con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsTable</span>(<span class="st">&quot;flights&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">isFALSE</span>()) con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbWriteTable</span>(<span class="st">&quot;flights&quot;</span>, nycflights13<span class="op">::</span>flights)</a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co"># work on lazy table</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co"># get all rows with no missing values</span></a>
<a class="sourceLine" id="cb11-5" title="5">flights_no_NA &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;flights&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">if_all</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(.)))</a>
<a class="sourceLine" id="cb11-7" title="7">flights_no_NA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">## [1] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;          &quot;tbl_lazy&quot;        </span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">## [5] &quot;tbl&quot;</span></a>
<a class="sourceLine" id="cb11-10" title="10">flights_no_NA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="kw">n</span>())</a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">## # Source:   SQL [1 x 1]</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">## # Database: postgres  [guest@localhost:5432/demo]</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">##     `n()`</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">##   &lt;int64&gt;</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">## 1  327346</span></a>
<a class="sourceLine" id="cb11-16" title="16"></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co"># number of NA on each columns</span></a>
<a class="sourceLine" id="cb11-18" title="18">flights_no_NA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb11-19" title="19">    <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb11-20" title="20">        <span class="dt">.cols =</span> <span class="kw">everything</span>(),</a>
<a class="sourceLine" id="cb11-21" title="21">        <span class="dt">.fns =</span> <span class="op">~</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(.x), <span class="dv">1</span>, <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>(),</a>
<a class="sourceLine" id="cb11-22" title="22">        <span class="dt">.names =</span> <span class="st">&quot;{.col}_NA&quot;</span></a>
<a class="sourceLine" id="cb11-23" title="23">    )</a>
<a class="sourceLine" id="cb11-24" title="24">)</a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">## # Source:   SQL [1 x 19]</span></a>
<a class="sourceLine" id="cb11-26" title="26"><span class="co">## # Database: postgres  [guest@localhost:5432/demo]</span></a>
<a class="sourceLine" id="cb11-27" title="27"><span class="co">##   year_NA month_NA day_NA dep_time_NA sched_dep_time_NA dep_delay_NA arr_time_NA</span></a>
<a class="sourceLine" id="cb11-28" title="28"><span class="co">##     &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;             &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb11-29" title="29"><span class="co">## 1       0        0      0           0                 0            0           0</span></a>
<a class="sourceLine" id="cb11-30" title="30"><span class="co">## # … with 12 more variables: sched_arr_time_NA &lt;dbl&gt;, arr_delay_NA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb11-31" title="31"><span class="co">## #   carrier_NA &lt;dbl&gt;, flight_NA &lt;dbl&gt;, tailnum_NA &lt;dbl&gt;, origin_NA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb11-32" title="32"><span class="co">## #   dest_NA &lt;dbl&gt;, air_time_NA &lt;dbl&gt;, distance_NA &lt;dbl&gt;, hour_NA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb11-33" title="33"><span class="co">## #   minute_NA &lt;dbl&gt;, time_hour_NA &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb11-34" title="34"></a>
<a class="sourceLine" id="cb11-35" title="35"><span class="co"># transform it into a view</span></a>
<a class="sourceLine" id="cb11-36" title="36">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(</a>
<a class="sourceLine" id="cb11-37" title="37">    <span class="dt">name =</span> <span class="st">&quot;flights_no_NA&quot;</span>,</a>
<a class="sourceLine" id="cb11-38" title="38">    <span class="dt">sql =</span> flights_no_NA <span class="op">%&gt;%</span><span class="st"> </span>dbplyr<span class="op">::</span><span class="kw">sql_render</span>()</a>
<a class="sourceLine" id="cb11-39" title="39">)</a>
<a class="sourceLine" id="cb11-40" title="40"></a>
<a class="sourceLine" id="cb11-41" title="41">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb11-42" title="42"><span class="co">## [1] &quot;mtcars&quot;        &quot;flights&quot;       &quot;flights_no_NA&quot;</span></a>
<a class="sourceLine" id="cb11-43" title="43">flights_view &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;flights_no_NA&quot;</span>)</a>
<a class="sourceLine" id="cb11-44" title="44">flights_no_NA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="kw">n</span>())</a>
<a class="sourceLine" id="cb11-45" title="45"><span class="co">## # Source:   SQL [1 x 1]</span></a>
<a class="sourceLine" id="cb11-46" title="46"><span class="co">## # Database: postgres  [guest@localhost:5432/demo]</span></a>
<a class="sourceLine" id="cb11-47" title="47"><span class="co">##     `n()`</span></a>
<a class="sourceLine" id="cb11-48" title="48"><span class="co">##   &lt;int64&gt;</span></a>
<a class="sourceLine" id="cb11-49" title="49"><span class="co">## 1  327346</span></a>
<a class="sourceLine" id="cb11-50" title="50">flights_view <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb11-51" title="51"><span class="co">## # Source:   SQL [6 x 19]</span></a>
<a class="sourceLine" id="cb11-52" title="52"><span class="co">## # Database: postgres  [guest@localhost:5432/demo]</span></a>
<a class="sourceLine" id="cb11-53" title="53"><span class="co">##    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time</span></a>
<a class="sourceLine" id="cb11-54" title="54"><span class="co">##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;</span></a>
<a class="sourceLine" id="cb11-55" title="55"><span class="co">## 1  2013     1     1      517            515         2      830            819</span></a>
<a class="sourceLine" id="cb11-56" title="56"><span class="co">## 2  2013     1     1      533            529         4      850            830</span></a>
<a class="sourceLine" id="cb11-57" title="57"><span class="co">## 3  2013     1     1      542            540         2      923            850</span></a>
<a class="sourceLine" id="cb11-58" title="58"><span class="co">## 4  2013     1     1      544            545        -1     1004           1022</span></a>
<a class="sourceLine" id="cb11-59" title="59"><span class="co">## 5  2013     1     1      554            600        -6      812            837</span></a>
<a class="sourceLine" id="cb11-60" title="60"><span class="co">## 6  2013     1     1      554            558        -4      740            728</span></a>
<a class="sourceLine" id="cb11-61" title="61"><span class="co">## # … with 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb11-62" title="62"><span class="co">## #   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb11-63" title="63"><span class="co">## #   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></a></code></pre></div>
</div>
</div>
<div id="list-views" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.2</span> List views<a href="#list-views" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Lists all view names, including temporary ones.</li>
<li>Returns a vector of strings representing view names.</li>
<li>The arguments <code>permanent = TRUE</code> and <code>temporary = TRUE</code> specify whether to include non-temporal and temporary views, respectively. An empty character will be returned if both are set to <code>FALSE</code>.</li>
</ul>
<div id="definition-3" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.1</span> Definition<a href="#definition-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">dbListViews &lt;-<span class="st"> </span><span class="cf">function</span>(con, <span class="dt">permanent =</span> <span class="ot">TRUE</span>, <span class="dt">temporary =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb12-2" title="2">    ret &lt;-<span class="st"> </span><span class="kw">character</span>()</a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="co"># this returns all views, temporary or not</span></a>
<a class="sourceLine" id="cb12-4" title="4">    list_views &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb12-5" title="5">        x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="st">            </span><span class="kw">dbListTables</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="st">            </span><span class="kw">setdiff</span>(</a>
<a class="sourceLine" id="cb12-8" title="8">                x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="st">                    </span>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb12-10" title="10">                        <span class="dt">statement =</span> <span class="st">&quot;SELECT tablename FROM pg_tables WHERE schemaname = current_schema()&quot;</span></a>
<a class="sourceLine" id="cb12-11" title="11">                    ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-12" title="12">            )</a>
<a class="sourceLine" id="cb12-13" title="13">    }</a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="co"># retruns only non-temporary views</span></a>
<a class="sourceLine" id="cb12-15" title="15">    parm_views &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb12-16" title="16">        x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="st">            </span><span class="kw">dbGetQuery</span>(</a>
<a class="sourceLine" id="cb12-18" title="18">                <span class="dt">statement =</span> <span class="st">&quot;SELECT viewname FROM pg_views WHERE schemaname = current_schema()&quot;</span></a>
<a class="sourceLine" id="cb12-19" title="19">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-20" title="20"><span class="st">            </span><span class="kw">pull</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-21" title="21">    }</a>
<a class="sourceLine" id="cb12-22" title="22">    <span class="co"># we can&#39;t use dplyr::case_when here, which requires the returned values be the same type and the same length.</span></a>
<a class="sourceLine" id="cb12-23" title="23">    <span class="cf">if</span> (permanent <span class="op">&amp;</span><span class="st"> </span>temporary) {</a>
<a class="sourceLine" id="cb12-24" title="24">        ret &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list_views</span>()</a>
<a class="sourceLine" id="cb12-25" title="25">    } <span class="cf">else</span> <span class="cf">if</span> (permanent) {</a>
<a class="sourceLine" id="cb12-26" title="26">        ret &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">parm_views</span>()</a>
<a class="sourceLine" id="cb12-27" title="27">    } <span class="cf">else</span> <span class="cf">if</span> (temporary) {</a>
<a class="sourceLine" id="cb12-28" title="28">        ret &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-29" title="29"><span class="st">            </span><span class="kw">list_views</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-30" title="30"><span class="st">            </span><span class="kw">setdiff</span>(con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">parm_views</span>())</a>
<a class="sourceLine" id="cb12-31" title="31">    }</a>
<a class="sourceLine" id="cb12-32" title="32">    ret <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">return</span>()</a>
<a class="sourceLine" id="cb12-33" title="33">}</a></code></pre></div>
</div>
<div id="example-3" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.2.2</span> Example<a href="#example-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">N &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb13-2" title="2">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars&quot;</span></a>
<a class="sourceLine" id="cb13-3" title="3">names &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span>N, <span class="op">~</span><span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;view_&quot;</span>, .x, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb13-4" title="4">names_tmp &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span>N, <span class="op">~</span><span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;view_temp_&quot;</span>, .x, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co"># non-temporary views</span></a>
<a class="sourceLine" id="cb13-6" title="6">purrr<span class="op">::</span><span class="kw">map_lgl</span>(names, <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, .x, sql))</a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">## [1] TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co"># temporary views</span></a>
<a class="sourceLine" id="cb13-9" title="9">purrr<span class="op">::</span><span class="kw">map_lgl</span>(names_tmp, <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, .x, sql, <span class="dt">temporary =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="co">## [1] TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co"># show temoporary views</span></a>
<a class="sourceLine" id="cb13-13" title="13">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>(<span class="dt">permanent =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-14" title="14"><span class="co">## [1] &quot;view_temp_1&quot; &quot;view_temp_2&quot; &quot;view_temp_3&quot;</span></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co"># show non-temoporary views</span></a>
<a class="sourceLine" id="cb13-16" title="16">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>(<span class="dt">temporary =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-17" title="17"><span class="co">## [1] &quot;view_1&quot; &quot;view_2&quot; &quot;view_3&quot;</span></a></code></pre></div>
</div>
</div>
<div id="test-views" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.3</span> Test existence of views<a href="#test-views" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Test the existence of views.</li>
<li>Returns a logical vector of the same length as the input.</li>
<li>Accpepts the same arguments as <code>dbCreateView</code>.</li>
</ul>
<div id="definition-4" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.3.1</span> Definition<a href="#definition-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">dbExistsViews &lt;-<span class="st"> </span><span class="cf">function</span>(con, names, <span class="dt">permanent =</span> <span class="ot">TRUE</span>, <span class="dt">temporary =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb14-2" title="2">    names <span class="op">%in%</span><span class="st"> </span><span class="kw">dbListViews</span>(con, permanent, temporary)</a>
<a class="sourceLine" id="cb14-3" title="3">}</a></code></pre></div>
</div>
<div id="example-4" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.3.2</span> Example<a href="#example-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars&quot;</span></a>
<a class="sourceLine" id="cb15-2" title="2">purrr<span class="op">::</span><span class="kw">map2_lgl</span>(</a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="dt">.x =</span> <span class="kw">c</span>(<span class="st">&quot;view&quot;</span>, <span class="st">&quot;view_temp&quot;</span>),</a>
<a class="sourceLine" id="cb15-4" title="4">    <span class="dt">.y =</span> <span class="kw">c</span>(<span class="ot">FALSE</span>, <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb15-5" title="5">    <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, .x, sql, <span class="dt">temporary =</span> .y)</a>
<a class="sourceLine" id="cb15-6" title="6">)</a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">## [1] TRUE TRUE</span></a>
<a class="sourceLine" id="cb15-8" title="8"></a>
<a class="sourceLine" id="cb15-9" title="9">viewnames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;view&quot;</span>, <span class="st">&quot;view_temp&quot;</span>, <span class="st">&quot;view_absent&quot;</span>)</a>
<a class="sourceLine" id="cb15-10" title="10">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsViews</span>(viewnames)</a>
<a class="sourceLine" id="cb15-11" title="11"><span class="co">## [1]  TRUE  TRUE FALSE</span></a>
<a class="sourceLine" id="cb15-12" title="12">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsViews</span>(viewnames, <span class="dt">permanent =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb15-13" title="13"><span class="co">## [1] FALSE  TRUE FALSE</span></a>
<a class="sourceLine" id="cb15-14" title="14">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbExistsViews</span>(viewnames, <span class="dt">temporary =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb15-15" title="15"><span class="co">## [1]  TRUE FALSE FALSE</span></a></code></pre></div>
</div>
</div>
<div id="drop-view" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.4</span> Drop a view<a href="#drop-view" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Drops a view.</li>
<li>Returns the total number of views dropped, invisibly.</li>
<li>The arguments <code>if_exists = FALSE</code> and <code>cascade = FALSE</code> specify whether to enable the corresponding SQL options. If <code>cascade = FALSE</code>, the default, then <code>RESTRICT</code> option is set.</li>
</ul>
<div id="definition-5" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.4.1</span> Definition<a href="#definition-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">dbDropView &lt;-<span class="st"> </span><span class="cf">function</span>(con, name, <span class="dt">if_exists =</span> <span class="ot">FALSE</span>, <span class="dt">cascade =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb16-2" title="2">    before &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">        </span><span class="kw">dbListViews</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">        </span><span class="kw">length</span>()</a>
<a class="sourceLine" id="cb16-5" title="5">    con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">sqlInterpolate</span>(</a>
<a class="sourceLine" id="cb16-7" title="7">            <span class="dt">sql =</span> <span class="st">&quot;DROP VIEW ?if_ex ?name ?cas_res&quot;</span>,</a>
<a class="sourceLine" id="cb16-8" title="8">            <span class="dt">if_ex =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(if_exists, <span class="st">&quot;IF EXISTS&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>(),</a>
<a class="sourceLine" id="cb16-9" title="9">            <span class="dt">name =</span> DBI<span class="op">::</span><span class="kw">dbQuoteIdentifier</span>(con, name),</a>
<a class="sourceLine" id="cb16-10" title="10">            <span class="dt">cas_res =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(cascade, <span class="st">&quot;CASCADE&quot;</span>, <span class="st">&quot;RESTRICT&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">SQL</span>()</a>
<a class="sourceLine" id="cb16-11" title="11">        ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">dbExecute</span>(con, .)</a>
<a class="sourceLine" id="cb16-13" title="13">    before <span class="op">-</span><span class="st"> </span>(con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">length</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">invisible</span>()</a>
<a class="sourceLine" id="cb16-14" title="14">}</a></code></pre></div>
</div>
<div id="example-5" class="section level3 hasAnchor">
<h3><span class="header-section-number">3.4.2</span> Example<a href="#example-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>View can be dropped in a vectorised way. If you are dropping temporary views only, then you can also use the <code>DISCARD</code> statement <a href="#discard">4.1</a>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co"># create views to demonstrate a vectorised removal</span></a>
<a class="sourceLine" id="cb17-2" title="2">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars LIMIT 10&quot;</span></a>
<a class="sourceLine" id="cb17-3" title="3">names &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;view&quot;</span>, .x, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb17-4" title="4">tmps &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="op">~</span><span class="st"> </span>.x <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb17-5" title="5">purrr<span class="op">::</span><span class="kw">map2_lgl</span>(names, tmps, <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, .x, sql, <span class="dt">temporary =</span> .y)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">invisible</span>() <span class="co"># discard output</span></a>
<a class="sourceLine" id="cb17-6" title="6"></a>
<a class="sourceLine" id="cb17-7" title="7">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>()</a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">## [1] &quot;view1&quot; &quot;view2&quot; &quot;view3&quot; &quot;view4&quot;</span></a>
<a class="sourceLine" id="cb17-9" title="9"></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co"># drop only temporary views</span></a>
<a class="sourceLine" id="cb17-11" title="11">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="st">    </span><span class="kw">dbListViews</span>(<span class="dt">temporary =</span> <span class="ot">TRUE</span>, <span class="dt">permanent =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map_int</span>(<span class="op">~</span><span class="st"> </span><span class="kw">dbDropView</span>(con, .x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="st">    </span><span class="kw">sum</span>() <span class="co"># total number of tables dropped</span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb17-16" title="16"></a>
<a class="sourceLine" id="cb17-17" title="17">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>() <span class="co"># non-temporary views are still alive</span></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="co">## [1] &quot;view3&quot; &quot;view4&quot;</span></a>
<a class="sourceLine" id="cb17-19" title="19"></a>
<a class="sourceLine" id="cb17-20" title="20"><span class="co"># drop them</span></a>
<a class="sourceLine" id="cb17-21" title="21">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-22" title="22"><span class="st">    </span><span class="kw">dbListViews</span>(<span class="dt">temporary =</span> <span class="ot">FALSE</span>, <span class="dt">permanent =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-23" title="23"><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map_int</span>(<span class="op">~</span><span class="st"> </span><span class="kw">dbDropView</span>(con, .x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-24" title="24"><span class="st">    </span><span class="kw">sum</span>()</a>
<a class="sourceLine" id="cb17-25" title="25"><span class="co">## [1] 2</span></a>
<a class="sourceLine" id="cb17-26" title="26"></a>
<a class="sourceLine" id="cb17-27" title="27">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>()</a>
<a class="sourceLine" id="cb17-28" title="28"><span class="co">## character(0)</span></a></code></pre></div>
<p>Dependent views could be a source of an error during this vectorised removal. Set <code>if_exists = TRUE</code> whenever <code>cascade = TRUE</code> to avoid this problem.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(</a>
<a class="sourceLine" id="cb18-2" title="2">    <span class="dt">name =</span> <span class="st">&quot;view_super&quot;</span>,</a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="dt">sql =</span> <span class="st">&quot;SELECT * FROM mtcars LIMIT 10&quot;</span></a>
<a class="sourceLine" id="cb18-4" title="4">)</a>
<a class="sourceLine" id="cb18-5" title="5">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbCreateView</span>(</a>
<a class="sourceLine" id="cb18-6" title="6">    <span class="dt">name =</span> <span class="st">&quot;view_sub&quot;</span>,</a>
<a class="sourceLine" id="cb18-7" title="7">    <span class="dt">sql =</span> <span class="st">&quot;SELECT * FROM view_super LIMIT 10&quot;</span></a>
<a class="sourceLine" id="cb18-8" title="8">)</a>
<a class="sourceLine" id="cb18-9" title="9"></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co"># set `if_exists = TRUE` to skip an cascade-dropped view</span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="kw">c</span>(<span class="st">&quot;view_super&quot;</span>, <span class="st">&quot;view_sub&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">dbDropView</span>(con, .x, <span class="dt">cascade =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">## </span><span class="al">NOTICE</span><span class="co">:  drop cascades to view view_sub</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">## Error: Failed to fetch row: ERROR:  view &quot;view_sub&quot; does not exist</span></a></code></pre></div>

</div>
</div>
</div>
<div id="misc" class="section level1 hasAnchor">
<h1><span class="header-section-number">4</span> Misc<a href="#misc" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="discard" class="section level2 hasAnchor">
<h2><span class="header-section-number">4.1</span> Free Resources<a href="#discard" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Executes a <code>DISCARD</code> SQL statement.</li>
<li>Returns <code>TRUE</code> invisibly even if it does nothing.</li>
<li>The arguments <code>all = FALSE</code>, <code>plans = FALSE</code> and <code>temporary = TRUE</code> specify which of the corresponding SQL statement option should be applied. If multiple options are selected, only the most dominant one will be executed. If none is selected, nothing will be done.</li>
</ul>
<div id="definition-6" class="section level3 hasAnchor">
<h3><span class="header-section-number">4.1.1</span> Definition<a href="#definition-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">dbDiscard &lt;-<span class="st"> </span><span class="cf">function</span>(con, <span class="dt">all =</span> <span class="ot">FALSE</span>, <span class="dt">plans =</span> <span class="ot">FALSE</span>, <span class="dt">temporary =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb19-2" title="2">    <span class="cf">if</span> (<span class="kw">c</span>(all, plans, temporary) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">any</span>()) {</a>
<a class="sourceLine" id="cb19-3" title="3">        resource &lt;-<span class="st"> </span><span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb19-4" title="4">            all <span class="op">~</span><span class="st"> &quot;ALL&quot;</span>,</a>
<a class="sourceLine" id="cb19-5" title="5">            plans <span class="op">~</span><span class="st"> &quot;PLANS&quot;</span>,</a>
<a class="sourceLine" id="cb19-6" title="6">            temporary <span class="op">~</span><span class="st"> &quot;TEMPORARY&quot;</span></a>
<a class="sourceLine" id="cb19-7" title="7">        )</a>
<a class="sourceLine" id="cb19-8" title="8">        <span class="st">&quot;DISCARD ?rsc&quot;</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="st">            </span>DBI<span class="op">::</span><span class="kw">sqlInterpolate</span>(</a>
<a class="sourceLine" id="cb19-10" title="10">                con,</a>
<a class="sourceLine" id="cb19-11" title="11">                .,</a>
<a class="sourceLine" id="cb19-12" title="12">                <span class="dt">rsc =</span> resource <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>()</a>
<a class="sourceLine" id="cb19-13" title="13">            ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="st">            </span>DBI<span class="op">::</span><span class="kw">dbExecute</span>(con, .)</a>
<a class="sourceLine" id="cb19-15" title="15">    }</a>
<a class="sourceLine" id="cb19-16" title="16">    <span class="kw">invisible</span>(<span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">return</span>()</a>
<a class="sourceLine" id="cb19-17" title="17">}</a></code></pre></div>
</div>
<div id="example-6" class="section level3 hasAnchor">
<h3><span class="header-section-number">4.1.2</span> Example<a href="#example-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>DISCARD TEMPORARY</code> frees all tempoary resources at once, including tempoary views, instead of listing and dropping them, as we did in <a href="#drop-view">3.4</a>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="co"># create temporary and non-temporary views</span></a>
<a class="sourceLine" id="cb20-2" title="2">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars LIMIT 10&quot;</span></a>
<a class="sourceLine" id="cb20-3" title="3">purrr<span class="op">::</span><span class="kw">map_lgl</span>(</a>
<a class="sourceLine" id="cb20-4" title="4">    <span class="dt">.x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb20-5" title="5">    <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(</a>
<a class="sourceLine" id="cb20-6" title="6">        con,</a>
<a class="sourceLine" id="cb20-7" title="7">        <span class="dt">name =</span> <span class="kw">paste</span>(<span class="st">&quot;view&quot;</span>, .x, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb20-8" title="8">        <span class="dt">sql =</span> sql,</a>
<a class="sourceLine" id="cb20-9" title="9">        <span class="dt">temporary =</span> <span class="kw">isTRUE</span>(.x <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-10" title="10">    )</a>
<a class="sourceLine" id="cb20-11" title="11">)</a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">## [1] TRUE TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb20-13" title="13"></a>
<a class="sourceLine" id="cb20-14" title="14">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>()</a>
<a class="sourceLine" id="cb20-15" title="15"><span class="co">## [1] &quot;view2&quot; &quot;view3&quot; &quot;view4&quot; &quot;view1&quot;</span></a>
<a class="sourceLine" id="cb20-16" title="16">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbDiscard</span>(<span class="dt">temporary =</span> <span class="ot">TRUE</span>) <span class="co"># delete all temporary objects</span></a>
<a class="sourceLine" id="cb20-17" title="17">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListViews</span>() <span class="co"># non-temporary views are still alive</span></a>
<a class="sourceLine" id="cb20-18" title="18"><span class="co">## [1] &quot;view3&quot; &quot;view4&quot;</span></a></code></pre></div>
</div>
</div>
<div id="drop-table" class="section level2 hasAnchor">
<h2><span class="header-section-number">4.2</span> Drop a Table<a href="#drop-table" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="definition-7" class="section level3 hasAnchor">
<h3><span class="header-section-number">4.2.1</span> Definition<a href="#definition-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>Drop a table, with <code>IF EXISTS</code> and <code>CASCADE</code> option.</li>
<li>Returns the total number of views dropped, invisibly.</li>
<li>See <a href="#dropview"><strong>??</strong></a> for the usage of optional arguments.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">dbDropTables &lt;-<span class="st"> </span><span class="cf">function</span>(conn, name, <span class="dt">if_exists =</span> <span class="ot">FALSE</span>, <span class="dt">cascade =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb21-2" title="2">    before &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">        </span><span class="kw">dbListTables</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">        </span><span class="kw">length</span>()</a>
<a class="sourceLine" id="cb21-5" title="5">    con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">sqlInterpolate</span>(</a>
<a class="sourceLine" id="cb21-7" title="7">            <span class="dt">sql =</span> <span class="st">&quot;DROP TABLE ?if_ex ?name ?cas_res&quot;</span>,</a>
<a class="sourceLine" id="cb21-8" title="8">            <span class="dt">if_ex =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(if_exists, <span class="st">&quot;IF EXISTS&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">SQL</span>(),</a>
<a class="sourceLine" id="cb21-9" title="9">            <span class="dt">name =</span> DBI<span class="op">::</span><span class="kw">dbQuoteIdentifier</span>(con, name),</a>
<a class="sourceLine" id="cb21-10" title="10">            <span class="dt">cas_res =</span> dplyr<span class="op">::</span><span class="kw">if_else</span>(cascade, <span class="st">&quot;CASCADE&quot;</span>, <span class="st">&quot;RESTRICT&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">SQL</span>()</a>
<a class="sourceLine" id="cb21-11" title="11">        ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="st">        </span>DBI<span class="op">::</span><span class="kw">dbExecute</span>(con, .)</a>
<a class="sourceLine" id="cb21-13" title="13">    before <span class="op">-</span><span class="st"> </span>(con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">length</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">invisible</span>()</a>
<a class="sourceLine" id="cb21-14" title="14">}</a></code></pre></div>
</div>
<div id="example-7" class="section level3 hasAnchor">
<h3><span class="header-section-number">4.2.2</span> Example<a href="#example-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">sql &lt;-<span class="st"> &quot;SELECT * FROM mtcars&quot;</span></a>
<a class="sourceLine" id="cb22-2" title="2">purrr<span class="op">::</span><span class="kw">map_lgl</span>(</a>
<a class="sourceLine" id="cb22-3" title="3">    <span class="dt">.x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb22-4" title="4">    <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span><span class="kw">dbCreateView</span>(con, <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;view&quot;</span>, .x), sql)</a>
<a class="sourceLine" id="cb22-5" title="5">)</a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co">## [1] TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb22-7" title="7">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb22-8" title="8"><span class="co">## [1] &quot;mtcars&quot; &quot;view2&quot;  &quot;view3&quot;  &quot;view1&quot;</span></a>
<a class="sourceLine" id="cb22-9" title="9"></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="co"># specifying a view causes an error</span></a>
<a class="sourceLine" id="cb22-11" title="11">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbDropTables</span>(<span class="st">&quot;view2&quot;</span>, <span class="dt">if_exists =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-12" title="12"><span class="co">## Error: Failed to fetch row: ERROR:  &quot;view2&quot; is not a table</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="co">## HINT:  Use DROP VIEW to remove a view.</span></a>
<a class="sourceLine" id="cb22-14" title="14">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb22-15" title="15"><span class="co">## [1] &quot;mtcars&quot; &quot;view2&quot;  &quot;view3&quot;  &quot;view1&quot;</span></a>
<a class="sourceLine" id="cb22-16" title="16"></a>
<a class="sourceLine" id="cb22-17" title="17"><span class="co"># specifying a referred table deletes all dependent views</span></a>
<a class="sourceLine" id="cb22-18" title="18">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbDropTables</span>(<span class="st">&quot;mtcars&quot;</span>, <span class="dt">cascade =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-19" title="19"><span class="co">## </span><span class="al">NOTICE</span><span class="co">:  drop cascades to 3 other objects</span></a>
<a class="sourceLine" id="cb22-20" title="20"><span class="co">## DETAIL:  drop cascades to view view1</span></a>
<a class="sourceLine" id="cb22-21" title="21"><span class="co">## drop cascades to view view2</span></a>
<a class="sourceLine" id="cb22-22" title="22"><span class="co">## drop cascades to view view3</span></a>
<a class="sourceLine" id="cb22-23" title="23"><span class="co">## [1] 4</span></a>
<a class="sourceLine" id="cb22-24" title="24">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb22-25" title="25"><span class="co">## character(0)</span></a></code></pre></div>

</div>
</div>
</div>
<div id="references" class="section level1 hasAnchor">
<h1><span class="header-section-number">5</span> References: dbplyr, DBI, RPostgres<a href="#references" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Introduction</p>
<ul>
<li><a href="https://yutatoyama.github.io/note/intro_R_for_SQL.html">巨大なデータがSQLサーバーにあるときに、Rでどう立ち向かうかマニュアル：dbplyrパッケージを中心として</a></li>
<li><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a></li>
<li><a href="https://nuitrcs.github.io/databases_workshop/r/r_databases.html">R: Working with Databases</a></li>
<li><a href="https://dbi.r-dbi.org/articles/dbi">Introduction to DBI</a></li>
</ul>
<p>DBI</p>
<ul>
<li><a href="http://delta0726.web.fc2.com/packages/database/00_RSQLite.html">RSQLite &amp; DBIの使い方</a></li>
<li><a href="https://dbi.r-dbi.org/articles/spec">DBI specification</a></li>
<li><a href="https://cran.r-project.org/web/packages/DBI/DBI.pdf">DBI: R Database Interface .pdf</a></li>
<li><a href="https://shena4746.github.io/code-examples-dbi-rpostgres/">Code Examples for DBI and RPostgres</a></li>
</ul>
<p>RPostgres</p>
<ul>
<li><a href="https://rpostgres.r-dbi.org/reference/index.html">RPostgres - Reference</a></li>
</ul>

</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "night",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "none",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

</body>

</html>
